name: Deploy to EC2

on:
  push:
    branches:
      - main

jobs:
  Deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Deploy to EC2
        uses: appleboy/ssh-action@master
        with:
          KEY: ${{ secrets.EC2_KEY }}
          HOSTNAME: ${{ secrets.EC2_HOST }}
          USER_NAME: ${{ secrets.EC2_USER }}
          port: 22
          debug: true
          sript: |
            ssh -o StrictHostKeyChecking=no ${USER_NAME}@${HOSTNAME} << 'EOF'
              # Navigate to your project directory
              cd ~/my-project
            
              # Install pm2 if not already installed
              if ! command -v pm2 &> /dev/null
              then
                echo "pm2 not found, installing..."
                sudo npm install -g pm2
              else
                echo "pm2 is already installed"
              fi

              # Pull the latest changes from the repository
              git pull origin main

              # Install the necessary dependencies
              npm install

              # Build the Strapi application
              npm build

              # Restart the Strapi server using pm2
              pm2 restart strapi-api || pm2 start npm --name strapi-api
            EOF
